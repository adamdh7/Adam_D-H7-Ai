<!DOCTYPE html>
<html lang="ht">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Adam_D'H7</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/jpeg" href="https://res.cloudinary.com/dglludnfq/image/upload/v1759278052/tf-stream-url/Screenshot_20250930_202003_Gallery.jpg" />
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dglludnfq/image/upload/v1759278052/tf-stream-url/Screenshot_20250930_202003_Gallery.jpg" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{ --bg:#000; --panel:#000; --ai-text:#d0d0d0; --user-blue:#0b3d91; --user-text:#e8f4ff; --header-h:56px; --form-h:84px; }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--ai-text);font-family:Arial,Helvetica,sans-serif;overflow:hidden;}
    header{position:fixed;top:0;left:0;right:0;height:var(--header-h);display:flex;align-items:center;justify-content:center;z-index:999;padding:0 12px}
    .menu-btn{position:absolute;left:12px;font-size:22px;cursor:pointer}
    .name-title{font-weight:800;color:#7d7d7d}
    .chat-box{position:fixed;left:0;right:0;top:var(--header-h);bottom:var(--form-h);overflow-y:auto;padding:12px 18px;box-sizing:border-box}
    .message{margin:12px 0;max-width:72%;word-break:break-word;white-space:pre-wrap}
    .message.user{align-self:flex-end}
    .message.bot{align-self:flex-start}
    .message.user .content{background:var(--user-blue);color:var(--user-text);border-radius:18px;padding:10px 14px}
    .message.bot .content{background:#262626;color:var(--ai-text);border-radius:18px;padding:10px 14px;border:1px solid rgba(255,255,255,0.04)}
    .thinking-dots{display:inline-flex;gap:8px}
    .thinking-dots span{width:9px;height:9px;border-radius:50%;background:#6faee6;opacity:0.12;animation:dot 1.6s infinite}
    @keyframes dot{0%{opacity:.12;transform:translateY(0)}25%{opacity:.9;transform:translateY(-7px)}55%{opacity:.35;transform:translateY(0)}100%{opacity:.12;transform:translateY(0)}}
    .sidebar{position:fixed;top:0;left:-100%;width:80%;height:100%;background:var(--panel);z-index:1001;transition:left .28s}
    .sidebar.active{left:0}
    form{display:flex;padding:12px;position:fixed;bottom:0;left:0;right:0;height:var(--form-h);align-items:center;gap:10px;box-sizing:border-box}
    textarea{flex:1;padding:10px;border-radius:18px;height:56px;background:#050505;color:var(--ai-text);border:1px solid rgba(255,255,255,0.04);resize:none}
    .send{width:48px;height:48px;border-radius:50%;border:none;background:linear-gradient(180deg,var(--user-blue),#06306a);display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .send[disabled]{opacity:.5;pointer-events:none}
    .copy-btn{position:absolute;top:10px;right:10px}
  </style>
</head>
<body>
  <header>
    <div class="menu-btn" onclick="toggleSidebar()">☰</div>
    <div class="name-title" id="headerName">Adam_D'H7</div>
  </header>

  <div class="sidebar" id="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px">
      <h3 style="margin:0">Chats</h3>
      <button onclick="newChat()">Nouveau Chat</button>
    </div>
    <ul id="chatList" style="list-style:none;padding:12px"></ul>
  </div>

  <div class="chat-box" id="chatBox" tabindex="-1" aria-live="polite"></div>

  <form id="chatForm" autocomplete="off" novalidate>
    <textarea id="userInput" placeholder="Adam_D'H7 le meilleure assistant" aria-label="Message"></textarea>
    <button id="sendBtn" class="send" type="submit" aria-label="Send">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M2 21L23 12L2 3L8 12L2 21Z"/></svg>
    </button>
  </form>

  <script>
    // Minimal, robust frontend:
    const headerEl = document.querySelector('header'), chatBox = document.getElementById('chatBox'), formEl = document.querySelector('form'), textarea = document.getElementById('userInput'), sendBtn = document.getElementById('sendBtn');
    function scrollToBottom(immediate=true){ try{ if(immediate) chatBox.scrollTop = chatBox.scrollHeight; else chatBox.scrollTo({ top: chatBox.scrollHeight, behavior:'smooth' }); }catch(e){} }
    function adjustLayout(){ const headerH = headerEl.offsetHeight || 56; const formH = formEl.offsetHeight || 84; chatBox.style.top = headerH + 'px'; chatBox.style.bottom = formH + 'px'; setTimeout(()=>scrollToBottom(true),60); }
    window.addEventListener('load', adjustLayout); window.addEventListener('resize', adjustLayout);

    const STORAGE_KEY = 'tfai_sessions'; let sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); let currentSession = sessions.length ? 0 : null;
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions)); }
    function toggleSidebar(){ const sb = document.getElementById('sidebar'); sb.classList.toggle('active'); }
    function newChat(){ sessions.unshift({ title:'Nouveau Chat', messages: [] }); currentSession = 0; save(); renderList(); renderBox(); document.getElementById('sidebar').classList.add('active'); }
    function renderList(){ const l = document.getElementById('chatList'); l.innerHTML=''; sessions.forEach((s,i)=>{ const li=document.createElement('li'); li.textContent = s.title||'Chat'; li.onclick = ()=>{ currentSession=i; renderBox(); toggleSidebar(); }; l.appendChild(li); }); }
    function renderBox(){ chatBox.innerHTML=''; if(currentSession===null){ chatBox.innerHTML='<div style="padding:20px">Aucun chat — nouveau chat</div>'; return; } const sess = sessions[currentSession]; sess.messages.forEach(m=>{ const wrap = document.createElement('div'); wrap.className = 'message ' + (m.sender==='user' ? 'user' : 'bot'); if(m.sender==='thinking'){ wrap.className='message bot thinking'; const c = document.createElement('div'); c.className='content'; c.innerHTML = '<div class=\"thinking-dots\"><span></span><span></span><span></span></div>'; wrap.appendChild(c); } else { const c = document.createElement('div'); c.className='content'; c.textContent = m.text; wrap.appendChild(c); } chatBox.appendChild(wrap); }); scrollToBottom(); }

    // helpers
    function genClientMsgId(){ if(typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID(); return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,9); }

    // prevent double send with inFlight flag + disable button
    let inFlight = false;
    const chatForm = document.getElementById('chatForm');

    chatForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const raw = textarea.value; const text = (typeof raw === 'string') ? raw.trim() : '';
      if(!text) return;
      if (inFlight) { console.log('Send in progress — ignoring duplicate submit'); return; }
      inFlight = true; sendBtn.disabled = true;

      if (currentSession === null) newChat();
      const sess = sessions[currentSession];
      const userMessage = { sender:'user', text, ts: Date.now() };
      sess.messages.push(userMessage); if(sess.messages[0] && typeof sess.messages[0].text==='string') sess.title = sess.messages[0].text.slice(0,100);
      save(); renderList(); renderBox();

      textarea.value=''; textarea.focus();
      const thinking = { sender:'thinking', ts: Date.now() }; sess.messages.push(thinking); save(); renderBox();

      const clientMsgId = genClientMsgId();
      let assistantAdded = false;
      const abortController = new AbortController();
      const TIMEOUT_MS = 30000;
      const timeoutId = setTimeout(()=> abortController.abort(), TIMEOUT_MS);

      try {
        // ensure user exists
        let tfid = localStorage.getItem('tfid');
        if (!tfid) {
          const ru = await fetch('/user', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
          if(!ru.ok) throw new Error('/user failed');
          const ju = await ru.json(); tfid = ju.tfid; localStorage.setItem('tfid', tfid);
        }
        // ensure session exists
        let sessionId = localStorage.getItem('currentSessionId');
        if (!sessionId) {
          const rs = await fetch('/session', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tfid }) });
          if(!rs.ok) throw new Error('/session failed');
          const js = await rs.json(); sessionId = js.sessionId; localStorage.setItem('currentSessionId', sessionId);
        }

        const r = await fetch('/message', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ tfid: localStorage.getItem('tfid'), sessionId: localStorage.getItem('currentSessionId'), text, clientMsgId }),
          signal: abortController.signal
        });
        clearTimeout(timeoutId);
        if (!r.ok) {
          const txt = await r.text().catch(()=>null);
          console.warn('/message returned not ok', r.status, txt);
          throw new Error('/message fail');
        }
        const jr = await r.json();
        // remove thinking
        const idx = sess.messages.indexOf(thinking); if (idx>-1) sess.messages.splice(idx,1);
        let assistantText = (jr && typeof jr.assistant === 'string' && jr.assistant.trim()) ? jr.assistant.trim() : '(Réponse peu claire)';
        sess.messages.push({ sender:'bot', text: assistantText, ts: Date.now() });
        assistantAdded = true; save(); renderBox();
      } catch(err){
        console.warn('Error sending message:', err && err.message ? err.message : err);
        try { const idx2 = sess.messages.findIndex(m=>m.sender==='thinking'); if(idx2!==-1) sess.messages.splice(idx2,1); } catch {}
        const lastBot = [...sess.messages].reverse().find(m=>m.sender==='bot');
        if(!lastBot) { sess.messages.push({ sender:'bot', text:'Réponse en attente (exemple)', ts: Date.now() }); }
        save(); renderBox();
      } finally {
        clearTimeout(timeoutId);
        inFlight = false;
        sendBtn.disabled = false;
        try { const idx2 = sess.messages.findIndex(m=>m.sender==='thinking'); if(idx2!==-1) sess.messages.splice(idx2,1); } catch {}
        const lastBot = [...sess.messages].reverse().find(m=>m.sender==='bot');
        if(!lastBot) { sess.messages.push({ sender:'bot', text:'Réponse en attente (exemple)', ts: Date.now() }); }
        save(); renderBox();
      }
    });

    // Enter = send, Shift+Enter = newline
    textarea.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(typeof chatForm.requestSubmit==='function') chatForm.requestSubmit(); else chatForm.dispatchEvent(new Event('submit',{ cancelable:true })); } });

    // initial render
    if (sessions.length) renderList(), renderBox();
    adjustLayout();
  </script>
</body>
</html>
